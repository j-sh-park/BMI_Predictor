---
title: "project"
author: "Anker,Alice,Utsav,James"
date: "11/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
devtools::install_github("ropenscilabs/gendercodeR")
#import libraries
library(tidyverse)
library(janitor)
library(skimr)
library(visdat)
library(gridExtra)
library(gt)
library(kableExtra)
library(GGally)
library(qtlcharts)
library(ggfortify) 
library(sjPlot)
options(knitr.table.format = "html")
```


# Exploratory Data Analysis(EDA)
```{r results ='hide'}
data = read.table("bodyfat.txt",header=TRUE) #read the data

glimpse(data)# Quick glimpse of the data
```
There are 250 observations and 16 variables in this data set. Each row represents an individual response and each column represents the features

```{r results='hide'}
skimr::skim(data)
```
```{r}
#Delete the density feature as the percentage body fat is calculated based on density. There is a strong correlation between each other
data = subset(data, select = -1)
```

## Variable selection using forward AIC

```{r}
M0 = lm(Pct.BF ~ 1, data = data) # Null model
M1 = lm(Pct.BF ~ ., data = data) # FUll model
step.fwd.aic = step(M0, scope = list(lower = M0, upper = M1), direction = "forward", trace = FALSE) 
round(summary(step.fwd.aic)$coef,3)
```

## Variable selection using backward AIC
```{r}
step.back.aic = step(M1, direction = "backward", trace = FALSE) 
round(summary(step.back.aic)$coef,3)
```
### Compare the backward and forward AIC methods

```{r}
sjPlot::tab_model( step.fwd.aic, step.back.aic, show.ci = FALSE, show.aic = TRUE, dv.labels = c("Forward model", "Backward model") )
```

Since backward AIC gives us smaller AIC, we decided to use backward AIC for variable selection


##Fit a simple linear mode



## pcentage body fat vs Height 
```{r}
lm1 = lm(Pct.BF ~ Height , data = data) 
summary(lm1)
sjPlot::tab_model(lm1, show.ci = FALSE)
```

```{r}
par(cex = 2) 
plot(Pct.BF ~ Height, data = data) 
abline(lm1, lwd = 3, col = "red")
```
```{r}
fitted1 = 477.2 + (-433.9) * data$Height
resid1 = data$Pct.BF - fitted1
```

## percentage body fat vs age
```{r}
lm2 = lm(Pct.BF ~ Age, data = data) 
summary(lm2)
sjPlot::tab_model(lm2, show.ci = FALSE)
```
```{r}
par(cex = 2) 
plot(Pct.BF~Age, data = data) 
abline(lm2, lwd = 3, col = "red")
```
```{r}
fitted2 = 10.35029  +  0.19342 * data$age
resid2 = data$Pct.BF - fitted2
```

## percentage body fat vs abdomen
```{r}
lm3 = lm(Pct.BF ~ Abdomen, data = data) 
summary(lm3)
sjPlot::tab_model(lm3, show.ci = FALSE)
```

```{r}
par(cex = 2) 
plot(Pct.BF~Abdomen, data = data) 
abline(lm3, lwd = 3, col = "red")
```
```{r}
fitted3 = -42.73413  + 0.66928 * data$abdomen
resid3 = data$Pct.BF - fitted2
```

## pcentage body fat vs Neck

```{r}
lm4 = lm(Pct.BF ~ Neck, data = data) 
summary(lm4)
sjPlot::tab_model(lm4, show.ci = FALSE)
```

```{r}
par(cex = 2) 
plot(Pct.BF~Neck, data = data) 
abline(lm4, lwd = 3, col = "red")
```

```{r}
fitted4 = -48.0929  +  1.7690  * data$Neck
resid4 = data$Pct.BF - fitted4
```

## pcentage body fat vs Hip

```{r}
lm5 = lm(Pct.BF ~ Hip, data = data) 
summary(lm5)
sjPlot::tab_model(lm5, show.ci = FALSE)
```

```{r}
par(cex = 2) 
plot(Pct.BF~Hip, data = data) 
abline(lm5, lwd = 3, col = "red")
```

```{r}
fitted5 = -62.1198 +  0.8144  * data$Hip
resid5 = data$Pct.BF - fitted5
```

## pcentage body fat vs Thigh

```{r}
lm6 = lm(Pct.BF ~ Thigh, data = data) 
summary(lm6)
sjPlot::tab_model(lm6, show.ci = FALSE)
```

```{r}
par(cex = 2) 
plot(Pct.BF~Thigh, data = data) 
abline(lm6, lwd = 3, col = "red")
```

```{r}
fitted6 = -62.1198 +  0.8144  * data$Thigh
resid6 = data$Pct.BF - fitted6
```

## pcentage body fat vs Forearm

```{r}
lm7 = lm(Pct.BF ~ Forearm, data = data) 
summary(lm7)
sjPlot::tab_model(lm7, show.ci = FALSE)
```

```{r}
par(cex = 2) 
plot(Pct.BF~Forearm, data = data) 
abline(lm7, lwd = 3, col = "red")
```

```{r}
fitted7 = -23.7060 + 1.4911 * data$Thigh
resid7 = data$Pct.BF - fitted7
```


## pcentage body fat vs wrist

```{r}
lm8 = lm(Pct.BF ~ Wrist, data = data) 
summary(lm8)
sjPlot::tab_model(lm8, show.ci = FALSE)
```

```{r}
par(cex = 2) 
plot(Pct.BF~Wrist, data = data) 
abline(lm8, lwd = 3, col = "red")
```

```{r}
fitted8 = -37.0207 + 3.0763 * data$Thigh
resid8 = data$Pct.BF - fitted8
```


## Chekcing assumptions

```{r}
ggplot(data, 
              aes(x = Height , y = Pct.BF)) + 
     geom_point(size = 1) + 
     theme_classic(base_size = 12) + 
     labs(x = "height",
          y = "Percentage body fat") +
     geom_smooth(method = "lm", se = FALSE) 
```

###Check linearity
```{r}
#percentage body fat vs density
p1 = ggplot(data, 
              aes(x = Height , y = Pct.BF)) + 
     geom_point(size = 1) + 
     theme_classic(base_size = 12) + 
     labs(x = "height",
          y = "Percentage body fat") +
     geom_smooth(method = "lm", se = FALSE) 

p2 = ggplot(data, 
              aes(x = Age , y = Pct.BF)) + 
     geom_point(size = 1) + 
     theme_classic(base_size = 12) + 
     labs(x = "Age",
          y = "Percentage body fat") +
     geom_smooth(method = "lm", se = FALSE) 

p3 = ggplot(data, 
              aes(x = Abdomen , y = Pct.BF)) + 
     geom_point(size = 1) + 
     theme_classic(base_size = 12) + 
     labs(x = "Abdomen",
          y = "Percentage body fat") +
     geom_smooth(method = "lm", se = FALSE) 

p4 = ggplot(data, 
              aes(x = Neck , y = Pct.BF)) + 
     geom_point(size = 1) + 
     theme_classic(base_size = 12) + 
     labs(x = "Neck",
          y = "Percentage body fat") +
     geom_smooth(method = "lm", se = FALSE) 

p5 = ggplot(data, 
              aes(x = Hip , y = Pct.BF)) + 
     geom_point(size = 1) + 
     theme_classic(base_size = 12) + 
     labs(x = "Hip",
          y = "Percentage body fat") +
     geom_smooth(method = "lm", se = FALSE) 

p6 = ggplot(data, 
              aes(x = Thigh, y = pct_bf)) + 
     geom_point(size = 1) + 
     theme_classic(base_size = 12) + 
     labs(x = "Thigh",
          y = "Percentage body fat") +
     geom_smooth(method = "lm", se = FALSE) 

p7 = ggplot(data, 
              aes(x = Forearm, y = Pct.BF)) + 
     geom_point(size = 1) + 
     theme_classic(base_size = 12) + 
     labs(x = "Forearm",
          y = "Percentage body fat") +
     geom_smooth(method = "lm", se = FALSE) 

p8 = ggplot(data, 
              aes(x = Wrist , y = Pct.BF)) + 
     geom_point(size = 1) + 
     theme_classic(base_size = 12) + 
     labs(x = "Wrist",
          y = "Percentage body fat") +
     geom_smooth(method = "lm", se = FALSE) 


#grid.arrange(p1, p2, p3, p4, p5, p6, p7, p8, nrow =4, ncol = 2)
```

All three plots shows strong linearity, though the variance of percentage body fat for people age 60 to 80 is a bit smaller than the people age from 20 -60. The linearity assumption is met.
### Check independence

All the observations are taken from different people, the data are independent of each other

### Check homoskedasiticy

```{r}
p9 = ggplot(data, 
            aes(x = Height, y = resid1)) + 
     geom_point(size = 1) + theme_classic(base_size = 12) + 
     labs(x = "Height", y = "Residual") + 
     geom_hline(yintercept = 0) 

p10 = ggplot(data, 
            aes(x = age, y = resid2)) + 
     geom_point(size = 1) + theme_classic(base_size = 12) + 
     labs(x = "Age", y = "Residual") + 
     geom_hline(yintercept = 0) 

p11 = ggplot(data, 
            aes(x = abdomen, y = resid3)) + 
     geom_point(size = 1) + theme_classic(base_size = 12) + 
     labs(x = "Abdomen", y = "Residual") + 
     geom_hline(yintercept = 0) 


grid.arrange(p4, p5, p6 ,nrow =2, ncol = 2)
```
The data in all plots seems have equal variance. A few outliers can be ignored. The homoskedasiticy assumption is met.

### Check normality

```{r}
autoplot(lm1, which = 1:2)
autoplot(lm2, which = 1:2)
autoplot(lm3, which = 1:2)
```
There are some departure in the higher quantiles for the first qq plot.

The age vs percentage body fat plot shows a some curvature. There are some departure in the lower quantiles for the first qq plot. This violates the normal distirbution assumption??

The Abdomen vs percentage body fat plot shows a some curvature. There are some departure in the lower quantiles for the first qq plot.

##Check multicolinearity
```{r}
#extract the data which is storngly correlated to percentage body fat
corr = data %>%
  select(pct_bf,density,age,abdomen) #select corr > 0.7 or < -0.7

#correlation matrix
GGally::ggpairs(corr) + theme_bw(base_size = 15)
```
It seems like there is a strong negative correlation between density and abdomen. We should drop one of them

# Modelling

#final linear regression model
```{r}
lm_final = lm(pct_bf ~ age + abdomen, data = data) # final
round(summary(lm_final)$coef, 3)
sjPlot::tab_model(lm3, show.ci = FALSE)

#lasso linear regression


#10 fold cross validation method to select  
#split the dataset into the training part 80% of the observation and 20% of the observation

#RMSE and MAE as criterion

```



